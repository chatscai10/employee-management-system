name: Deploy Employee Management System

on:
  push:
    branches: [ main, develop ]
  pull_request:
    branches: [ main ]

env:
  PROJECT_ID: employee-management-system
  GKE_CLUSTER: employee-management-cluster
  GKE_ZONE: asia-east1-a
  REGISTRY_HOST: gcr.io

jobs:
  # ä»£ç¢¼å“è³ªæª¢æŸ¥
  code-quality:
    runs-on: ubuntu-latest
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      
    - name: Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: '18'
        cache: 'npm'
        
    - name: Install dependencies
      run: |
        if [ -f package.json ]; then
          npm ci
        else
          echo "No package.json found, skipping npm install"
        fi
        
    - name: Run ESLint (if available)
      run: |
        if [ -f package.json ] && npm ls eslint > /dev/null 2>&1; then
          npm run lint
        else
          echo "ESLint not configured, skipping"
        fi
        
    - name: Validate JavaScript syntax
      run: |
        find . -name "*.js" -not -path "./node_modules/*" -exec node -c {} \;
        echo "JavaScript syntax validation completed"

  # å®‰å…¨æ€§æƒæ
  security-scan:
    runs-on: ubuntu-latest
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      
    - name: Run security audit
      run: |
        if [ -f package.json ]; then
          npm audit --audit-level=high
        else
          echo "No package.json found, skipping npm audit"
        fi
        
    - name: Scan for secrets
      uses: trufflesecurity/trufflehog@main
      with:
        path: ./
        base: main
        head: HEAD

  # å»ºç½®å’Œæ¸¬è©¦
  build-and-test:
    runs-on: ubuntu-latest
    needs: [code-quality, security-scan]
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      
    - name: Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: '18'
        
    - name: Validate Google Apps Script files
      run: |
        echo "Validating Google Apps Script project structure..."
        
        # æª¢æŸ¥å¿…è¦æª”æ¡ˆå­˜åœ¨
        if [ ! -f "backend/gas-main.js" ]; then
          echo "âŒ Missing backend/gas-main.js"
          exit 1
        fi
        
        if [ ! -f "frontend/index.html" ]; then
          echo "âŒ Missing frontend/index.html"
          exit 1
        fi
        
        if [ ! -f "database/sheets-schema.md" ]; then
          echo "âŒ Missing database/sheets-schema.md"
          exit 1
        fi
        
        echo "âœ… Project structure validation passed"
        
    - name: Test JavaScript modules
      run: |
        echo "Testing JavaScript module syntax..."
        
        # æ¸¬è©¦å¾Œç«¯æ¨¡çµ„
        for file in backend/modules/*.js; do
          if [ -f "$file" ]; then
            node -c "$file"
            echo "âœ… $file syntax OK"
          fi
        done
        
        # æ¸¬è©¦å‰ç«¯æ¨¡çµ„
        for file in frontend/js/**/*.js; do
          if [ -f "$file" ]; then
            node -c "$file"
            echo "âœ… $file syntax OK"
          fi
        done
        
    - name: Create deployment package
      run: |
        echo "Creating deployment package..."
        mkdir -p dist/
        
        # è¤‡è£½å‰ç«¯æª”æ¡ˆ
        cp -r frontend/* dist/
        
        # è¤‡è£½å¾Œç«¯æª”æ¡ˆåˆ°é©ç•¶ä½ç½®
        mkdir -p dist/backend
        cp -r backend/* dist/backend/
        
        # è¤‡è£½éƒ¨ç½²æ–‡æª”
        cp -r deployment dist/
        
        echo "âœ… Deployment package created"
        
    - name: Upload build artifacts
      uses: actions/upload-artifact@v4
      with:
        name: deployment-package
        path: dist/
        retention-days: 30

  # Google Apps Script éƒ¨ç½² (åƒ…åœ¨ main åˆ†æ”¯)
  deploy-gas:
    runs-on: ubuntu-latest
    needs: build-and-test
    if: github.ref == 'refs/heads/main' && github.event_name == 'push'
    environment: production
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      
    - name: Download build artifacts
      uses: actions/download-artifact@v4
      with:
        name: deployment-package
        path: dist/
        
    - name: Setup clasp (Google Apps Script CLI)
      run: |
        npm install -g @google/clasp
        
    - name: Authenticate with Google Apps Script
      run: |
        echo '${{ secrets.CLASP_CREDENTIALS }}' > ~/.clasprc.json
        
    - name: Deploy to Google Apps Script
      run: |
        # è¨­å®šå°ˆæ¡ˆID
        echo '{"scriptId":"${{ secrets.GAS_SCRIPT_ID }}","rootDir":"./backend"}' > .clasp.json
        
        # æ¨é€ä»£ç¢¼
        clasp push --force
        
        # éƒ¨ç½²æ–°ç‰ˆæœ¬
        clasp deploy --description "Automated deployment from GitHub Actions - $(date)"
        
        echo "âœ… Google Apps Script deployment completed"

  # Cloud Run éƒ¨ç½² (é€²éšæ–¹æ¡ˆ)
  deploy-cloud-run:
    runs-on: ubuntu-latest
    needs: build-and-test
    if: github.ref == 'refs/heads/main' && github.event_name == 'push'
    environment: cloud-production
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      
    - name: Setup Google Cloud CLI
      uses: google-github-actions/setup-gcloud@v2
      with:
        service_account_key: ${{ secrets.GCP_SA_KEY }}
        project_id: ${{ env.PROJECT_ID }}
        
    - name: Configure Docker
      run: gcloud --quiet auth configure-docker
      
    - name: Build Docker image
      run: |
        docker build -t ${{ env.REGISTRY_HOST }}/${{ env.PROJECT_ID }}/employee-management:${{ github.sha }} .
        
    - name: Run security scan on image
      uses: aquasecurity/trivy-action@master
      with:
        image-ref: ${{ env.REGISTRY_HOST }}/${{ env.PROJECT_ID }}/employee-management:${{ github.sha }}
        format: 'sarif'
        output: 'trivy-results.sarif'
        
    - name: Push Docker image
      run: |
        docker push ${{ env.REGISTRY_HOST }}/${{ env.PROJECT_ID }}/employee-management:${{ github.sha }}
        
    - name: Deploy to Cloud Run
      run: |
        gcloud run deploy employee-management \
          --image ${{ env.REGISTRY_HOST }}/${{ env.PROJECT_ID }}/employee-management:${{ github.sha }} \
          --region asia-east1 \
          --platform managed \
          --allow-unauthenticated \
          --set-env-vars="NODE_ENV=production" \
          --set-env-vars="TELEGRAM_BOT_TOKEN=${{ secrets.TELEGRAM_BOT_TOKEN }}" \
          --memory=512Mi \
          --cpu=1 \
          --max-instances=10 \
          --timeout=300
          
        echo "âœ… Cloud Run deployment completed"

  # Kubernetes éƒ¨ç½² (ä¼æ¥­æ–¹æ¡ˆ)
  deploy-kubernetes:
    runs-on: ubuntu-latest
    needs: build-and-test
    if: github.ref == 'refs/heads/main' && github.event_name == 'push'
    environment: k8s-production
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      
    - name: Setup Google Cloud CLI
      uses: google-github-actions/setup-gcloud@v2
      with:
        service_account_key: ${{ secrets.GCP_SA_KEY }}
        project_id: ${{ env.PROJECT_ID }}
        
    - name: Get GKE credentials
      run: |
        gcloud container clusters get-credentials ${{ env.GKE_CLUSTER }} --zone ${{ env.GKE_ZONE }}
        
    - name: Setup kubectl
      uses: azure/setup-kubectl@v3
      with:
        version: 'latest'
        
    - name: Build and push Docker image
      run: |
        gcloud --quiet auth configure-docker
        docker build -t ${{ env.REGISTRY_HOST }}/${{ env.PROJECT_ID }}/employee-management:${{ github.sha }} .
        docker push ${{ env.REGISTRY_HOST }}/${{ env.PROJECT_ID }}/employee-management:${{ github.sha }}
        
    - name: Deploy to Kubernetes
      run: |
        # æ›´æ–° deployment æ˜ åƒ
        kubectl set image deployment/employee-management \
          employee-management=${{ env.REGISTRY_HOST }}/${{ env.PROJECT_ID }}/employee-management:${{ github.sha }}
          
        # ç­‰å¾… rollout å®Œæˆ
        kubectl rollout status deployment/employee-management --timeout=300s
        
        echo "âœ… Kubernetes deployment completed"

  # éƒ¨ç½²æ¸¬è©¦
  deployment-test:
    runs-on: ubuntu-latest
    needs: [deploy-gas]
    if: always() && (needs.deploy-gas.result == 'success' || needs.deploy-cloud-run.result == 'success' || needs.deploy-kubernetes.result == 'success')
    
    steps:
    - name: Test deployment endpoints
      run: |
        echo "Testing deployment endpoints..."
        
        # å¦‚æœæœ‰éƒ¨ç½² URLï¼Œæ¸¬è©¦å¯ç”¨æ€§
        if [ -n "${{ secrets.DEPLOYMENT_URL }}" ]; then
          response=$(curl -s -o /dev/null -w "%{http_code}" "${{ secrets.DEPLOYMENT_URL }}")
          if [ $response -eq 200 ]; then
            echo "âœ… Deployment endpoint is responding"
          else
            echo "âŒ Deployment endpoint returned HTTP $response"
            exit 1
          fi
        else
          echo "â„¹ï¸  No deployment URL configured for testing"
        fi

  # é€šçŸ¥éƒ¨ç½²çµæœ
  notify-deployment:
    runs-on: ubuntu-latest
    needs: [deploy-gas, deploy-cloud-run, deploy-kubernetes, deployment-test]
    if: always()
    
    steps:
    - name: Send Telegram notification
      if: github.ref == 'refs/heads/main'
      run: |
        # ç¢ºå®šéƒ¨ç½²ç‹€æ…‹
        if [ "${{ needs.deploy-gas.result }}" == "success" ] || \
           [ "${{ needs.deploy-cloud-run.result }}" == "success" ] || \
           [ "${{ needs.deploy-kubernetes.result }}" == "success" ]; then
          STATUS="âœ… æˆåŠŸ"
          MESSAGE="ğŸš€ ä¼æ¥­å“¡å·¥ç®¡ç†ç³»çµ±éƒ¨ç½²æˆåŠŸï¼

ğŸ“‹ éƒ¨ç½²è©³æƒ…:
â€¢ æäº¤: ${{ github.sha }}
â€¢ åˆ†æ”¯: ${{ github.ref_name }}
â€¢ æäº¤è€…: ${{ github.actor }}
â€¢ æ™‚é–“: $(date '+%Y-%m-%d %H:%M:%S')

ğŸ”— éƒ¨ç½²ç’°å¢ƒ:
${{ needs.deploy-gas.result == 'success' && 'â€¢ Google Apps Script: å·²éƒ¨ç½²' || '' }}
${{ needs.deploy-cloud-run.result == 'success' && 'â€¢ Cloud Run: å·²éƒ¨ç½²' || '' }}
${{ needs.deploy-kubernetes.result == 'success' && 'â€¢ Kubernetes: å·²éƒ¨ç½²' || '' }}

âœ… ç³»çµ±å·²ä¸Šç·šä¸¦å¯ä¾›ä½¿ç”¨"
        else
          STATUS="âŒ å¤±æ•—"
          MESSAGE="ğŸš¨ ä¼æ¥­å“¡å·¥ç®¡ç†ç³»çµ±éƒ¨ç½²å¤±æ•—ï¼

ğŸ“‹ å¤±æ•—è©³æƒ…:
â€¢ æäº¤: ${{ github.sha }}
â€¢ åˆ†æ”¯: ${{ github.ref_name }}
â€¢ éŒ¯èª¤æ™‚é–“: $(date '+%Y-%m-%d %H:%M:%S')

è«‹æª¢æŸ¥ GitHub Actions æ—¥èªŒä»¥äº†è§£è©³ç´°éŒ¯èª¤è³‡è¨Šã€‚"
        fi
        
        # ç™¼é€ Telegram é€šçŸ¥
        if [ -n "${{ secrets.TELEGRAM_BOT_TOKEN }}" ] && [ -n "${{ secrets.TELEGRAM_CHAT_ID }}" ]; then
          curl -s -X POST "https://api.telegram.org/bot${{ secrets.TELEGRAM_BOT_TOKEN }}/sendMessage" \
            -d "chat_id=${{ secrets.TELEGRAM_CHAT_ID }}" \
            -d "text=${MESSAGE}" \
            -d "parse_mode=HTML"
          echo "ğŸ“± Telegram notification sent: $STATUS"
        else
          echo "â„¹ï¸  Telegram credentials not configured"
        fi

  # æ¸…ç†èˆŠç‰ˆæœ¬ (å¯é¸)
  cleanup:
    runs-on: ubuntu-latest
    needs: [notify-deployment]
    if: github.ref == 'refs/heads/main' && success()
    
    steps:
    - name: Cleanup old container images
      run: |
        echo "Cleaning up old container images..."
        
        # ä¿ç•™æœ€è¿‘ 10 å€‹ç‰ˆæœ¬
        gcloud container images list-tags ${{ env.REGISTRY_HOST }}/${{ env.PROJECT_ID }}/employee-management \
          --limit=999999 --sort-by=TIMESTAMP \
          --format="get(digest)" | tail -n +11 | while read digest; do
          gcloud container images delete "${{ env.REGISTRY_HOST }}/${{ env.PROJECT_ID }}/employee-management@${digest}" --force-delete-tags --quiet
        done
        
        echo "âœ… Cleanup completed"