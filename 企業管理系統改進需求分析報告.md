# 企業管理系統改進需求分析報告

## 📋 執行摘要

本報告針對企業管理系統的四大核心模組進行深度需求分析，包含營收系統、叫貨系統、排班系統及其他系統問題的改進方案。系統涉及多店面管理、複雜排班規則、即時通知機制等關鍵功能，需要系統性的架構重新設計。

---

## 1. 📊 營收系統改進需求分析

### 1.1 現狀問題分析
- **收入項目管理**：缺乏預設收入來源的標準化顯示
- **分店選擇**：缺少分店篩選功能，影響數據準確性
- **支出項目**：現有自定義新增方式需要保留

### 1.2 改進需求詳述

#### 收入項目標準化
```
需求：預設顯示全部收入來源
- 現場收入
- 熊貓外送
- UBER外送
- 其他平台收入（可擴展）
```

#### 分店選擇功能
```
需求：新增分店選擇下拉選單
- 支援多分店數據管理
- 分店別營收統計
- 權限控制（員工只能看自己分店）
```

### 1.3 資料庫設計建議

```sql
-- 營收系統相關表結構
CREATE TABLE revenue_categories (
    id INT PRIMARY KEY AUTO_INCREMENT,
    name VARCHAR(50) NOT NULL COMMENT '收入類別名稱',
    type ENUM('income', 'expense') NOT NULL COMMENT '收入/支出',
    is_default BOOLEAN DEFAULT FALSE COMMENT '是否為預設項目',
    is_active BOOLEAN DEFAULT TRUE,
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP
);

CREATE TABLE revenue_records (
    id INT PRIMARY KEY AUTO_INCREMENT,
    store_id INT NOT NULL COMMENT '分店ID',
    category_id INT NOT NULL COMMENT '收入類別ID',
    amount DECIMAL(10,2) NOT NULL COMMENT '金額',
    description TEXT COMMENT '說明',
    record_date DATE NOT NULL COMMENT '記錄日期',
    created_by INT NOT NULL COMMENT '建立者',
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    FOREIGN KEY (store_id) REFERENCES stores(id),
    FOREIGN KEY (category_id) REFERENCES revenue_categories(id),
    FOREIGN KEY (created_by) REFERENCES users(id)
);

-- 預設收入類別數據
INSERT INTO revenue_categories (name, type, is_default) VALUES
('現場收入', 'income', TRUE),
('熊貓外送', 'income', TRUE),
('UBER外送', 'income', TRUE),
('其他外送平台', 'income', TRUE);
```

---

## 2. 📦 叫貨系統改進需求分析

### 2.1 現狀問題分析
- **分店選擇**：叫貨頁面缺少分店選項
- **明細確認**：缺少品項明細給員工確認
- **備註顯示**：品項備註未正確顯示
- **分類篩選**：缺少品項分類篩選功能
- **異常回報**：缺少品項異常回報機制

### 2.2 改進需求詳述

#### 分店選擇功能
```
需求：叫貨頁面新增分店選擇
- 下拉選單選擇分店
- 根據分店權限顯示
- 影響庫存和供應商資料
```

#### 明細確認系統
```
需求：下方顯示叫貨明細
- 即時顯示已選品項
- 數量、單價、小計
- 總計金額計算
- 修改/刪除功能
```

#### 備註顯示優化
```
需求：品項內顯示備註
- 供應商備註
- 保存條件
- 採購注意事項
```

#### 分類篩選功能
```
需求：品項分類篩選
- 全部分類選項
- 依分類快速篩選
- 搜尋功能整合
```

#### 異常回報機制
```
需求：品項異常回報
- 品質問題回報
- 數量短缺回報
- 規格不符回報
- 狀態追蹤
```

### 2.3 資料庫設計建議

```sql
-- 叫貨系統相關表結構
CREATE TABLE product_categories (
    id INT PRIMARY KEY AUTO_INCREMENT,
    name VARCHAR(50) NOT NULL COMMENT '分類名稱',
    sort_order INT DEFAULT 0 COMMENT '排序',
    is_active BOOLEAN DEFAULT TRUE,
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP
);

CREATE TABLE products (
    id INT PRIMARY KEY AUTO_INCREMENT,
    category_id INT NOT NULL COMMENT '分類ID',
    name VARCHAR(100) NOT NULL COMMENT '品項名稱',
    unit VARCHAR(20) NOT NULL COMMENT '單位',
    supplier_notes TEXT COMMENT '供應商備註',
    storage_notes TEXT COMMENT '保存備註',
    purchase_notes TEXT COMMENT '採購備註',
    is_active BOOLEAN DEFAULT TRUE,
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    FOREIGN KEY (category_id) REFERENCES product_categories(id)
);

CREATE TABLE purchase_orders (
    id INT PRIMARY KEY AUTO_INCREMENT,
    store_id INT NOT NULL COMMENT '分店ID',
    order_number VARCHAR(50) UNIQUE NOT NULL COMMENT '叫貨單號',
    status ENUM('draft', 'submitted', 'approved', 'delivered', 'completed') DEFAULT 'draft',
    total_amount DECIMAL(10,2) DEFAULT 0 COMMENT '總金額',
    notes TEXT COMMENT '備註',
    created_by INT NOT NULL COMMENT '建立者',
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    submitted_at TIMESTAMP NULL COMMENT '提交時間',
    FOREIGN KEY (store_id) REFERENCES stores(id),
    FOREIGN KEY (created_by) REFERENCES users(id)
);

CREATE TABLE purchase_order_items (
    id INT PRIMARY KEY AUTO_INCREMENT,
    order_id INT NOT NULL COMMENT '叫貨單ID',
    product_id INT NOT NULL COMMENT '品項ID',
    quantity DECIMAL(10,3) NOT NULL COMMENT '數量',
    unit_price DECIMAL(10,2) DEFAULT 0 COMMENT '單價',
    subtotal DECIMAL(10,2) DEFAULT 0 COMMENT '小計',
    notes TEXT COMMENT '品項備註',
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    FOREIGN KEY (order_id) REFERENCES purchase_orders(id),
    FOREIGN KEY (product_id) REFERENCES products(id)
);

CREATE TABLE product_issue_reports (
    id INT PRIMARY KEY AUTO_INCREMENT,
    order_id INT NOT NULL COMMENT '叫貨單ID',
    product_id INT NOT NULL COMMENT '品項ID',
    issue_type ENUM('quality', 'quantity', 'specification', 'other') NOT NULL COMMENT '問題類型',
    description TEXT NOT NULL COMMENT '問題描述',
    status ENUM('pending', 'investigating', 'resolved', 'closed') DEFAULT 'pending',
    reported_by INT NOT NULL COMMENT '回報者',
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    resolved_at TIMESTAMP NULL COMMENT '解決時間',
    FOREIGN KEY (order_id) REFERENCES purchase_orders(id),
    FOREIGN KEY (product_id) REFERENCES products(id),
    FOREIGN KEY (reported_by) REFERENCES users(id)
);
```

---

## 3. 📅 排班系統詳細規則分析

### 3.1 複雜規則分析

#### 時間規則
```
週末定義：星期五、六、日
排班月份：自動預設下個月
操作時間限制：5分鐘超時
系統開放時間：每月16號02:00-21號02:00
```

#### 休假限制規則
```
個人休假限制：
- 每人休假上限：8天/月
- 週末休假上限：3天/月（五六日）

群體休假限制：
- 每日總休假上限：2人
- 同店每日休假上限：1人
- 待命每日休假上限：1人
- 兼職每日休假上限：1人
```

#### 特殊日期設定
```
禁休日期：各分店JSON設計
公休日期：各分店JSON設計
即時規則檢查：點擊操作時驗證
```

### 3.2 資料庫設計建議

```sql
-- 排班系統相關表結構
CREATE TABLE shift_schedules (
    id INT PRIMARY KEY AUTO_INCREMENT,
    year INT NOT NULL COMMENT '年份',
    month INT NOT NULL COMMENT '月份',
    status ENUM('preparing', 'open', 'closed', 'completed') DEFAULT 'preparing' COMMENT '狀態',
    open_time DATETIME COMMENT '開放時間',
    close_time DATETIME COMMENT '關閉時間',
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    UNIQUE KEY unique_year_month (year, month)
);

CREATE TABLE employee_types (
    id INT PRIMARY KEY AUTO_INCREMENT,
    name VARCHAR(50) NOT NULL COMMENT '員工類型',
    daily_off_limit INT DEFAULT 1 COMMENT '每日休假上限'
);

CREATE TABLE shift_rules (
    id INT PRIMARY KEY AUTO_INCREMENT,
    rule_type VARCHAR(50) NOT NULL COMMENT '規則類型',
    rule_value JSON NOT NULL COMMENT '規則值',
    description TEXT COMMENT '規則說明',
    is_active BOOLEAN DEFAULT TRUE,
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP
);

CREATE TABLE store_special_dates (
    id INT PRIMARY KEY AUTO_INCREMENT,
    store_id INT NOT NULL COMMENT '分店ID',
    year INT NOT NULL COMMENT '年份',
    month INT NOT NULL COMMENT '月份',
    no_off_dates JSON COMMENT '禁休日期',
    public_holidays JSON COMMENT '公休日期',
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    FOREIGN KEY (store_id) REFERENCES stores(id),
    UNIQUE KEY unique_store_year_month (store_id, year, month)
);

CREATE TABLE shift_requests (
    id INT PRIMARY KEY AUTO_INCREMENT,
    schedule_id INT NOT NULL COMMENT '排班計畫ID',
    user_id INT NOT NULL COMMENT '員工ID',
    request_dates JSON NOT NULL COMMENT '申請休假日期',
    weekend_dates JSON COMMENT '週末休假日期',
    status ENUM('draft', 'submitted', 'approved', 'rejected') DEFAULT 'draft',
    session_start TIMESTAMP COMMENT '操作開始時間',
    session_end TIMESTAMP COMMENT '操作結束時間',
    submitted_at TIMESTAMP NULL COMMENT '提交時間',
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    FOREIGN KEY (schedule_id) REFERENCES shift_schedules(id),
    FOREIGN KEY (user_id) REFERENCES users(id)
);

CREATE TABLE shift_validations (
    id INT PRIMARY KEY AUTO_INCREMENT,
    request_id INT NOT NULL COMMENT '申請ID',
    validation_type VARCHAR(50) NOT NULL COMMENT '驗證類型',
    is_valid BOOLEAN NOT NULL COMMENT '是否通過',
    error_message TEXT COMMENT '錯誤訊息',
    checked_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    FOREIGN KEY (request_id) REFERENCES shift_requests(id)
);
```

### 3.3 排班規則驗證邏輯

```javascript
// 排班規則驗證核心邏輯
class ShiftValidationEngine {
    async validateShiftRequest(userId, requestDates, scheduleId) {
        const validations = [
            this.validateMonthlyLimit(userId, requestDates),
            this.validateWeekendLimit(userId, requestDates),
            this.validateDailyLimit(requestDates, scheduleId),
            this.validateStoreLimit(userId, requestDates, scheduleId),
            this.validateSpecialDates(userId, requestDates, scheduleId),
            this.validateEmployeeTypeLimit(userId, requestDates, scheduleId)
        ];
        
        const results = await Promise.all(validations);
        return this.aggregateResults(results);
    }
    
    validateMonthlyLimit(userId, requestDates) {
        // 每人每月休假上限8天驗證
        const totalDays = requestDates.length;
        return {
            type: 'monthly_limit',
            isValid: totalDays <= 8,
            message: totalDays > 8 ? `超過每月休假上限(8天)，目前申請${totalDays}天` : null
        };
    }
    
    validateWeekendLimit(userId, requestDates) {
        // 週末休假上限3天驗證（五六日）
        const weekendDays = requestDates.filter(date => this.isWeekend(date));
        return {
            type: 'weekend_limit',
            isValid: weekendDays.length <= 3,
            message: weekendDays.length > 3 ? `超過週末休假上限(3天)，目前申請${weekendDays.length}天` : null
        };
    }
    
    async validateDailyLimit(requestDates, scheduleId) {
        // 每日總休假上限2人驗證
        const dailyChecks = [];
        for (const date of requestDates) {
            const existingOffs = await this.getExistingOffsForDate(date, scheduleId);
            dailyChecks.push({
                date,
                isValid: existingOffs < 2,
                message: existingOffs >= 2 ? `${date}已達每日休假上限(2人)` : null
            });
        }
        return { type: 'daily_limit', checks: dailyChecks };
    }
}
```

---

## 4. 🔧 其他系統問題分析

### 4.1 通知系統問題

#### 員工打卡通知缺失
```
問題：打卡系統通知訊息沒有發送
解決方案：
- 檢查通知服務配置
- 實作Line/Telegram通知機制
- 建立通知日誌記錄
```

#### 照片上傳通知
```
問題：營業額和維修照片需要傳送到老闆群組
解決方案：
- 整合Line Bot或Telegram Bot
- 自動轉發機制
- 照片壓縮和備份
```

### 4.2 管理功能缺失

#### 照片查詢功能
```
問題：管理員缺少分類照片查詢功能
解決方案：
- 照片分類系統
- 進階搜尋功能
- 批次處理功能
```

#### 紀錄作廢功能
```
問題：員工紀錄作廢功能未實作
替代方案評估：
- 作廢功能 vs 自主更改（12小時內限制1次）
- 權限控制和稽核日誌
```

### 4.3 資料庫設計建議

```sql
-- 通知系統相關表結構
CREATE TABLE notification_templates (
    id INT PRIMARY KEY AUTO_INCREMENT,
    name VARCHAR(100) NOT NULL COMMENT '模板名稱',
    type ENUM('line', 'telegram', 'email', 'sms') NOT NULL COMMENT '通知類型',
    template TEXT NOT NULL COMMENT '模板內容',
    is_active BOOLEAN DEFAULT TRUE,
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP
);

CREATE TABLE notification_logs (
    id INT PRIMARY KEY AUTO_INCREMENT,
    template_id INT COMMENT '模板ID',
    recipient_type ENUM('user', 'group', 'admin') NOT NULL COMMENT '接收者類型',
    recipient_id VARCHAR(100) NOT NULL COMMENT '接收者ID',
    content TEXT NOT NULL COMMENT '發送內容',
    status ENUM('pending', 'sent', 'failed', 'delivered') DEFAULT 'pending',
    sent_at TIMESTAMP NULL COMMENT '發送時間',
    error_message TEXT COMMENT '錯誤訊息',
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    FOREIGN KEY (template_id) REFERENCES notification_templates(id)
);

-- 照片管理相關表結構
CREATE TABLE photo_categories (
    id INT PRIMARY KEY AUTO_INCREMENT,
    name VARCHAR(50) NOT NULL COMMENT '照片分類',
    description TEXT COMMENT '分類說明',
    is_active BOOLEAN DEFAULT TRUE,
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP
);

CREATE TABLE photos (
    id INT PRIMARY KEY AUTO_INCREMENT,
    category_id INT NOT NULL COMMENT '分類ID',
    store_id INT COMMENT '分店ID',
    title VARCHAR(200) COMMENT '照片標題',
    file_path VARCHAR(500) NOT NULL COMMENT '檔案路徑',
    file_size INT COMMENT '檔案大小',
    upload_date DATE NOT NULL COMMENT '上傳日期',
    uploaded_by INT NOT NULL COMMENT '上傳者',
    is_sent_to_boss BOOLEAN DEFAULT FALSE COMMENT '是否已發送給老闆',
    sent_at TIMESTAMP NULL COMMENT '發送時間',
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    FOREIGN KEY (category_id) REFERENCES photo_categories(id),
    FOREIGN KEY (store_id) REFERENCES stores(id),
    FOREIGN KEY (uploaded_by) REFERENCES users(id)
);

-- 紀錄修改日誌
CREATE TABLE record_modifications (
    id INT PRIMARY KEY AUTO_INCREMENT,
    table_name VARCHAR(50) NOT NULL COMMENT '資料表名稱',
    record_id INT NOT NULL COMMENT '紀錄ID',
    action ENUM('create', 'update', 'delete', 'void') NOT NULL COMMENT '操作類型',
    old_data JSON COMMENT '原始資料',
    new_data JSON COMMENT '新資料',
    modified_by INT NOT NULL COMMENT '修改者',
    modification_reason TEXT COMMENT '修改原因',
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    FOREIGN KEY (modified_by) REFERENCES users(id)
);
```

---

## 5. 🏗️ 功能模組架構規劃

### 5.1 系統架構概覽

```
企業管理系統架構
├── 前端層 (Frontend)
│   ├── 管理者介面 (Admin Panel)
│   ├── 員工操作介面 (Employee Dashboard)
│   └── 行動版介面 (Mobile Interface)
│
├── 業務邏輯層 (Business Logic)
│   ├── 營收管理模組 (Revenue Management)
│   ├── 叫貨管理模組 (Purchase Order Management)
│   ├── 排班管理模組 (Shift Scheduling)
│   ├── 通知服務模組 (Notification Service)
│   └── 權限控制模組 (Access Control)
│
├── 資料存取層 (Data Access)
│   ├── 資料庫連接層 (Database Connection)
│   ├── 快取服務 (Cache Service)
│   └── 檔案儲存服務 (File Storage)
│
└── 基礎設施層 (Infrastructure)
    ├── 資料庫 (MySQL/PostgreSQL)
    ├── 快取 (Redis)
    ├── 檔案儲存 (Local/Cloud Storage)
    └── 外部API (Line/Telegram Bot)
```

### 5.2 核心模組設計

#### 營收管理模組
```javascript
// 營收管理核心類別
class RevenueManagementModule {
    constructor() {
        this.categoryService = new RevenueCategoryService();
        this.recordService = new RevenueRecordService();
        this.storeService = new StoreService();
    }
    
    async getDefaultIncomeCategories() {
        return await this.categoryService.getDefaultCategories('income');
    }
    
    async createRevenueRecord(storeId, categoryId, amount, description, date) {
        // 驗證分店權限
        await this.validateStoreAccess(storeId);
        
        // 建立營收紀錄
        return await this.recordService.create({
            store_id: storeId,
            category_id: categoryId,
            amount: amount,
            description: description,
            record_date: date
        });
    }
    
    async getRevenueByStore(storeId, startDate, endDate) {
        return await this.recordService.getByStoreAndDateRange(
            storeId, startDate, endDate
        );
    }
}
```

#### 叫貨管理模組
```javascript
// 叫貨管理核心類別
class PurchaseOrderModule {
    constructor() {
        this.orderService = new PurchaseOrderService();
        this.productService = new ProductService();
        this.issueReportService = new IssueReportService();
    }
    
    async createOrder(storeId, items) {
        // 建立叫貨單
        const order = await this.orderService.create(storeId);
        
        // 新增品項明細
        for (const item of items) {
            await this.orderService.addItem(order.id, item);
        }
        
        // 計算總金額
        await this.orderService.calculateTotal(order.id);
        
        return order;
    }
    
    async getProductsByCategory(categoryId = null) {
        if (categoryId) {
            return await this.productService.getByCategory(categoryId);
        }
        return await this.productService.getAll();
    }
    
    async reportIssue(orderId, productId, issueType, description) {
        return await this.issueReportService.create({
            order_id: orderId,
            product_id: productId,
            issue_type: issueType,
            description: description
        });
    }
}
```

#### 排班管理模組
```javascript
// 排班管理核心類別
class ShiftSchedulingModule {
    constructor() {
        this.scheduleService = new ShiftScheduleService();
        this.validationEngine = new ShiftValidationEngine();
        this.ruleService = new ShiftRuleService();
    }
    
    async openScheduling(year, month) {
        // 檢查是否在開放時間內
        const now = new Date();
        const openTime = new Date(year, month-1, 16, 2, 0, 0); // 16號02:00
        const closeTime = new Date(year, month-1, 21, 2, 0, 0); // 21號02:00
        
        if (now < openTime || now > closeTime) {
            throw new Error('不在排班開放時間內');
        }
        
        return await this.scheduleService.createOrUpdate(year, month, 'open');
    }
    
    async submitShiftRequest(userId, scheduleId, requestDates) {
        // 驗證排班規則
        const validation = await this.validationEngine.validateShiftRequest(
            userId, requestDates, scheduleId
        );
        
        if (!validation.isValid) {
            throw new Error(validation.errors.join(', '));
        }
        
        // 建立排班申請
        return await this.scheduleService.createRequest({
            user_id: userId,
            schedule_id: scheduleId,
            request_dates: requestDates
        });
    }
    
    async getScheduleCalendar(scheduleId) {
        const schedule = await this.scheduleService.getById(scheduleId);
        const requests = await this.scheduleService.getRequestsBySchedule(scheduleId);
        const specialDates = await this.scheduleService.getSpecialDates(scheduleId);
        
        return this.buildCalendarData(schedule, requests, specialDates);
    }
}
```

---

## 6. 📅 開發優先順序建議

### 6.1 第一階段 (高優先級 - 1-2週)

#### P1 - 營收系統改進
```
工作項目：
✅ 預設收入類別實作
✅ 分店選擇功能
✅ 資料庫結構調整
✅ 基本CRUD功能

預估工時：3-5天
技術難度：低
業務影響：高
```

#### P2 - 叫貨系統基礎改進
```
工作項目：
✅ 分店選擇功能
✅ 品項明細確認系統
✅ 備註顯示優化
✅ 基本分類篩選

預估工時：5-7天
技術難度：中
業務影響：高
```

### 6.2 第二階段 (中優先級 - 2-3週)

#### P3 - 通知系統修復
```
工作項目：
✅ 打卡通知修復
✅ 照片上傳通知實作
✅ Line/Telegram Bot整合
✅ 通知日誌系統

預估工時：4-6天
技術難度：中
業務影響：中
```

#### P4 - 叫貨系統進階功能
```
工作項目：
✅ 品項異常回報系統
✅ 進階搜尋和篩選
✅ 批次處理功能
✅ 供應商管理整合

預估工時：6-8天
技術難度：中高
業務影響：中
```

### 6.3 第三階段 (複雜功能 - 3-4週)

#### P5 - 排班系統實作
```
工作項目：
✅ 複雜規則引擎開發
✅ 月曆介面實作
✅ 即時驗證系統
✅ 定時任務系統
✅ 會話管理機制

預估工時：12-15天
技術難度：高
業務影響：高
```

### 6.4 第四階段 (優化改進 - 1-2週)

#### P6 - 系統優化和完善
```
工作項目：
✅ 管理員照片查詢功能
✅ 紀錄作廢/修改機制
✅ 效能優化
✅ 系統測試和除錯
✅ 文檔撰寫

預估工時：8-10天
技術難度：中
業務影響：中
```

---

## 7. 💻 技術實現方案

### 7.1 前端技術選型

#### 建議技術棧
```
前端框架：Vue.js 3 / React 18
UI框架：Element Plus / Ant Design
狀態管理：Pinia / Redux Toolkit
日期處理：Day.js
圖表庫：ECharts / Chart.js
行動端：響應式設計 + PWA
```

#### 關鍵實作重點
```javascript
// 排班月曆組件實作範例
<template>
  <div class="shift-calendar">
    <calendar-header 
      :year="currentYear" 
      :month="currentMonth"
      @month-change="handleMonthChange"
    />
    
    <calendar-grid 
      :dates="calendarDates"
      :shift-data="shiftData"
      :special-dates="specialDates"
      @date-click="handleDateClick"
    />
    
    <shift-summary 
      :selected-dates="selectedDates"
      :validation-result="validationResult"
    />
  </div>
</template>

<script>
export default {
  data() {
    return {
      selectedDates: [],
      validationResult: null,
      sessionTimer: null
    }
  },
  
  mounted() {
    this.startSessionTimer(); // 5分鐘計時器
  },
  
  methods: {
    async handleDateClick(date) {
      // 即時規則驗證
      const validation = await this.validateDateSelection(date);
      
      if (validation.isValid) {
        this.toggleDateSelection(date);
      } else {
        this.showValidationError(validation.message);
      }
    },
    
    startSessionTimer() {
      this.sessionTimer = setTimeout(() => {
        this.forceLogout();
      }, 5 * 60 * 1000); // 5分鐘
    }
  }
}
</script>
```

### 7.2 後端技術選型

#### 建議技術棧
```
後端框架：Node.js + Express / Laravel / ASP.NET Core
資料庫：MySQL 8.0 / PostgreSQL
快取：Redis
任務佇列：Bull Queue / Laravel Queue
檔案儲存：Local Storage / AWS S3
API文檔：Swagger/OpenAPI
```

#### 排班規則引擎實作
```javascript
// 排班規則引擎核心實作
class ShiftRuleEngine {
    constructor() {
        this.rules = new Map();
        this.loadRules();
    }
    
    loadRules() {
        // 載入所有排班規則
        this.rules.set('monthly_limit', new MonthlyLimitRule(8));
        this.rules.set('weekend_limit', new WeekendLimitRule(3));
        this.rules.set('daily_limit', new DailyLimitRule(2));
        this.rules.set('store_limit', new StoreLimitRule(1));
        this.rules.set('employee_type_limit', new EmployeeTypeLimitRule());
    }
    
    async validateRequest(context) {
        const results = [];
        
        for (const [ruleName, rule] of this.rules) {
            try {
                const result = await rule.validate(context);
                results.push({
                    rule: ruleName,
                    isValid: result.isValid,
                    message: result.message,
                    details: result.details
                });
            } catch (error) {
                results.push({
                    rule: ruleName,
                    isValid: false,
                    message: `規則驗證錯誤: ${error.message}`,
                    error: error
                });
            }
        }
        
        return {
            isValid: results.every(r => r.isValid),
            results: results,
            errors: results.filter(r => !r.isValid).map(r => r.message)
        };
    }
}

// 每月休假限制規則
class MonthlyLimitRule {
    constructor(limit) {
        this.limit = limit;
    }
    
    async validate(context) {
        const { userId, requestDates, scheduleId } = context;
        
        // 查詢本月已申請的休假天數
        const existingDays = await this.getExistingOffDays(userId, scheduleId);
        const totalDays = existingDays + requestDates.length;
        
        return {
            isValid: totalDays <= this.limit,
            message: totalDays > this.limit ? 
                `超過每月休假上限(${this.limit}天)，目前總計${totalDays}天` : null,
            details: {
                existing: existingDays,
                requesting: requestDates.length,
                total: totalDays,
                limit: this.limit
            }
        };
    }
}
```

### 7.3 資料庫優化方案

#### 索引策略
```sql
-- 關鍵索引設計
CREATE INDEX idx_revenue_records_store_date ON revenue_records(store_id, record_date);
CREATE INDEX idx_purchase_orders_store_status ON purchase_orders(store_id, status);
CREATE INDEX idx_shift_requests_schedule_user ON shift_requests(schedule_id, user_id);
CREATE INDEX idx_photos_category_date ON photos(category_id, upload_date);
CREATE INDEX idx_notification_logs_status_created ON notification_logs(status, created_at);

-- 複合索引優化查詢效能
CREATE INDEX idx_shift_complex ON shift_requests(schedule_id, user_id, status, submitted_at);
```

#### 分區策略
```sql
-- 依日期分區優化查詢效能
CREATE TABLE revenue_records_partitioned (
    id INT AUTO_INCREMENT,
    store_id INT NOT NULL,
    category_id INT NOT NULL,
    amount DECIMAL(10,2) NOT NULL,
    record_date DATE NOT NULL,
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    PRIMARY KEY (id, record_date)
) PARTITION BY RANGE (YEAR(record_date)) (
    PARTITION p2023 VALUES LESS THAN (2024),
    PARTITION p2024 VALUES LESS THAN (2025),
    PARTITION p2025 VALUES LESS THAN (2026),
    PARTITION pmax VALUES LESS THAN MAXVALUE
);
```

---

## 8. ⚠️ 風險評估和建議

### 8.1 技術風險

#### 高風險項目
```
🚨 排班系統複雜度
風險：規則引擎複雜，容易出現邏輯錯誤
影響：業務流程中斷，員工排班混亂
緩解措施：
- 完整的單元測試覆蓋
- 分階段開發和測試
- 設置規則驗證的回滾機制
```

#### 中風險項目
```
⚠️ 通知系統穩定性
風險：外部API依賴可能失效
影響：重要訊息無法及時送達
緩解措施：
- 多重通知管道備援
- 失敗重送機制
- 通知狀態監控
```

#### 低風險項目
```
ℹ️ 資料遷移複雜度
風險：現有資料結構調整可能影響既有功能
影響：短期功能中斷
緩解措施：
- 完整的資料備份
- 段階式遷移計畫
- 回滾計畫準備
```

### 8.2 業務風險

#### 營運中斷風險
```
風險評估：中等
- 系統升級期間可能的服務中斷
- 員工適應新功能需要時間

緩解策略：
- 選擇低峰時段進行升級
- 提供完整的教育訓練
- 準備緊急備援流程
```

#### 資料安全風險
```
風險評估：中等
- 新增通知功能可能的資料洩露
- 照片上傳和儲存的安全性

緩解策略：
- 實施嚴格的權限控制
- 加密敏感資料傳輸
- 定期安全稽核
```

### 8.3 專案執行風險

#### 時程風險
```
風險：排班系統開發時間可能超預期
原因：規則複雜度高，測試案例多
對策：
- 採用敏捷開發方法
- 設置里程碑檢查點
- 預留緩衝時間
```

#### 資源風險
```
風險：同時開發多個模組可能造成資源不足
對策：
- 明確優先順序
- 合理分配開發人力
- 考慮外包部分功能
```

### 8.4 建議執行策略

#### 漸進式部署
```
第一階段：營收系統改進（風險最低）
第二階段：叫貨系統優化（中等風險）
第三階段：通知系統修復（中等風險）
第四階段：排班系統實作（最高風險）
```

#### 品質保證措施
```
✅ 自動化測試：單元測試、整合測試、端到端測試
✅ 程式碼審查：雙人審查制度
✅ 效能測試：負載測試、壓力測試
✅ 安全測試：滲透測試、漏洞掃描
✅ 使用者測試：內部測試、使用者接受測試
```

---

## 9. 📋 總結與下一步

### 9.1 關鍵改進點摘要

1. **營收系統**：標準化收入類別、新增分店選擇功能
2. **叫貨系統**：完善明細確認、品項分類、異常回報機制
3. **排班系統**：實作複雜規則引擎、月曆操作介面
4. **通知系統**：修復打卡通知、實作照片自動轉發
5. **管理功能**：新增照片查詢、完善紀錄修改機制

### 9.2 預估開發週期

```
總計開發時間：8-10週
- 第一階段：1-2週（營收+叫貨基礎）
- 第二階段：2-3週（通知+叫貨進階）
- 第三階段：3-4週（排班系統）
- 第四階段：1-2週（優化完善）
- 測試調整：1週
```

### 9.3 資源需求評估

```
開發人力：2-3名全端工程師
設計資源：1名UI/UX設計師
測試資源：1名測試工程師
專案管理：1名專案經理
```

### 9.4 立即行動項目

1. **技術評估**：確認現有技術棧和系統架構
2. **需求確認**：與業務團隊確認詳細需求
3. **資源規劃**：分配開發團隊和時程
4. **環境準備**：建立開發、測試、生產環境
5. **風險規劃**：制定詳細的風險應對計畫

---

*本報告基於提供的需求進行深度分析，建議在實際開發前進行更詳細的技術調研和需求確認。*