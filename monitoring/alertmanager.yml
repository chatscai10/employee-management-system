# AlertManager é…ç½®
# ä¼æ¥­å“¡å·¥ç®¡ç†ç³»çµ±è­¦å‘Šé€šçŸ¥è¨­å®š

global:
  # SMTP é…ç½® (éƒµä»¶é€šçŸ¥)
  smtp_smarthost: 'smtp.gmail.com:587'
  smtp_from: 'alerts@yourcompany.com'
  smtp_auth_username: 'alerts@yourcompany.com'
  smtp_auth_password: 'your-app-password'

# æ¨¡æ¿é…ç½®
templates:
  - '/etc/alertmanager/templates/*.tmpl'

# è·¯ç”±é…ç½®
route:
  group_by: ['alertname', 'severity']
  group_wait: 10s
  group_interval: 10s
  repeat_interval: 1h
  receiver: 'web.hook'
  routes:
    # ç·Šæ€¥è­¦å‘Š - ç«‹å³é€šçŸ¥
    - match:
        severity: critical
      receiver: 'critical-alerts'
      group_wait: 0s
      repeat_interval: 5m

    # ä¸€èˆ¬è­¦å‘Š - æ‰¹æ¬¡é€šçŸ¥
    - match:
        severity: warning
      receiver: 'warning-alerts'
      group_interval: 5m
      repeat_interval: 30m

# é€šçŸ¥æ¥æ”¶å™¨é…ç½®
receivers:
  # é è¨­æ¥æ”¶å™¨
  - name: 'web.hook'
    webhook_configs:
      - url: 'http://localhost:8080/api/webhook/alerts'
        send_resolved: true

  # ç·Šæ€¥è­¦å‘Šæ¥æ”¶å™¨
  - name: 'critical-alerts'
    # Telegram é€šçŸ¥
    webhook_configs:
      - url: 'https://api.telegram.org/bot${TELEGRAM_BOT_TOKEN}/sendMessage'
        send_resolved: true
        http_config:
          method: POST
        title: 'ğŸš¨ ç·Šæ€¥è­¦å‘Š'
        text: |
          ğŸš¨ **ç·Šæ€¥è­¦å‘Š**
          
          **è­¦å‘Šåç¨±**: {{ .GroupLabels.alertname }}
          **åš´é‡ç¨‹åº¦**: {{ .GroupLabels.severity }}
          **è§¸ç™¼æ™‚é–“**: {{ .CommonAnnotations.timestamp }}
          
          **è©³ç´°èªªæ˜**:
          {{ range .Alerts }}
          - {{ .Annotations.summary }}
          - {{ .Annotations.description }}
          {{ end }}
          
          **éœ€è¦ç«‹å³è™•ç†ï¼**

    # éƒµä»¶é€šçŸ¥
    email_configs:
      - to: 'admin@yourcompany.com'
        subject: 'ğŸš¨ ä¼æ¥­å“¡å·¥ç®¡ç†ç³»çµ±ç·Šæ€¥è­¦å‘Š'
        body: |
          ç·Šæ€¥è­¦å‘Šé€šçŸ¥
          
          è­¦å‘Šåç¨±: {{ .GroupLabels.alertname }}
          åš´é‡ç¨‹åº¦: {{ .GroupLabels.severity }}
          è§¸ç™¼æ™‚é–“: {{ .CommonAnnotations.timestamp }}
          
          è©³ç´°è³‡è¨Š:
          {{ range .Alerts }}
          - {{ .Annotations.summary }}
          - {{ .Annotations.description }}
          {{ end }}
          
          è«‹ç«‹å³æª¢æŸ¥ç³»çµ±ç‹€æ…‹ä¸¦é€²è¡Œè™•ç†ã€‚

    # SMS é€šçŸ¥ (é€éç¬¬ä¸‰æ–¹æœå‹™)
    webhook_configs:
      - url: 'https://api.twilio.com/2010-04-01/Accounts/YOUR_ACCOUNT_SID/Messages.json'
        send_resolved: false
        http_config:
          method: POST
          basic_auth:
            username: 'YOUR_ACCOUNT_SID'
            password: 'YOUR_AUTH_TOKEN'
        title: 'ç·Šæ€¥è­¦å‘Š'
        text: |
          ä¼æ¥­å“¡å·¥ç®¡ç†ç³»çµ±ç·Šæ€¥è­¦å‘Š: {{ .GroupLabels.alertname }}

  # ä¸€èˆ¬è­¦å‘Šæ¥æ”¶å™¨
  - name: 'warning-alerts'
    # Telegram é€šçŸ¥
    webhook_configs:
      - url: 'https://api.telegram.org/bot${TELEGRAM_BOT_TOKEN}/sendMessage'
        send_resolved: true
        title: 'âš ï¸ ç³»çµ±è­¦å‘Š'
        text: |
          âš ï¸ **ç³»çµ±è­¦å‘Š**
          
          **è­¦å‘Šåç¨±**: {{ .GroupLabels.alertname }}
          **åš´é‡ç¨‹åº¦**: {{ .GroupLabels.severity }}
          **è§¸ç™¼æ™‚é–“**: {{ .CommonAnnotations.timestamp }}
          
          **è©³ç´°èªªæ˜**:
          {{ range .Alerts }}
          - {{ .Annotations.summary }}
          {{ end }}

    # éƒµä»¶é€šçŸ¥
    email_configs:
      - to: 'team@yourcompany.com'
        subject: 'âš ï¸ ä¼æ¥­å“¡å·¥ç®¡ç†ç³»çµ±è­¦å‘Š'
        body: |
          ç³»çµ±è­¦å‘Šé€šçŸ¥
          
          è­¦å‘Šåç¨±: {{ .GroupLabels.alertname }}
          åš´é‡ç¨‹åº¦: {{ .GroupLabels.severity }}
          è§¸ç™¼æ™‚é–“: {{ .CommonAnnotations.timestamp }}
          
          è«‹é—œæ³¨ç³»çµ±ç‹€æ…‹ã€‚

# æŠ‘åˆ¶è¦å‰‡ (é¿å…é‡è¤‡è­¦å‘Š)
inhibit_rules:
  - source_match:
      severity: 'critical'
    target_match:
      severity: 'warning'
    equal: ['alertname', 'instance']

# éœéŸ³é…ç½®
silences:
  # ç¶­è­·æœŸé–“éœéŸ³ (ç¯„ä¾‹)
  - matcher:
      name: "alertname"
      value: ".*"
    startsAt: "2024-01-01T02:00:00Z"
    endsAt: "2024-01-01T04:00:00Z"
    comment: "å®šæœŸç¶­è­·æœŸé–“"