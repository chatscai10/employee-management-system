/**
 * Ë®≠ÂÇôÊåáÁ¥ãÂ∑•ÂÖ∑Ê®°ÁµÑ - ÁîüÊàêÂîØ‰∏ÄË®≠ÂÇôË≠òÂà•
 */

class DeviceUtils {
    constructor() {
        this.fingerprint = null;
        this.fingerprintTimestamp = null;
        this.cacheExpiration = 24 * 60 * 60 * 1000; // 24Â∞èÊôÇÁ∑©Â≠ò
    }

    /**
     * ÁîüÊàêË®≠ÂÇôÊåáÁ¥ãÔºà‰∏ªË¶ÅÊñπÊ≥ïÔºâ
     */
    async generateFingerprint(forceRefresh = false) {
        // Ê™¢Êü•Á∑©Â≠ò
        if (!forceRefresh && this.isValidCachedFingerprint()) {
            return this.fingerprint;
        }

        try {
            const components = await this.collectFingerprintComponents();
            const fingerprintString = this.combineComponents(components);
            const hashedFingerprint = await this.hashFingerprint(fingerprintString);
            
            // ÂâµÂª∫ÂÆåÊï¥ÁöÑË®≠ÂÇôÊåáÁ¥ãÂ∞çË±°
            this.fingerprint = {
                hash: hashedFingerprint,
                components: components,
                timestamp: Date.now(),
                version: '1.0'
            };
            
            this.fingerprintTimestamp = Date.now();
            
            // ‰øùÂ≠òÂà∞localStorageÔºàÂèØÈÅ∏Ôºâ
            this.saveFingerprintToCache();
            
            this.logDeviceEvent('FINGERPRINT_GENERATED', this.fingerprint);
            return this.fingerprint;
            
        } catch (error) {
            this.logDeviceEvent('FINGERPRINT_ERROR', null, error);
            throw new DeviceError(`Ë®≠ÂÇôÊåáÁ¥ãÁîüÊàêÂ§±Êïó: ${error.message}`);
        }
    }

    /**
     * Êî∂ÈõÜË®≠ÂÇôÊåáÁ¥ãÁµÑ‰ª∂
     */
    async collectFingerprintComponents() {
        const components = {};

        try {
            // Âü∫Êú¨ÁÄèË¶ΩÂô®Ë≥áË®ä
            components.userAgent = navigator.userAgent;
            components.language = navigator.language;
            components.languages = navigator.languages ? navigator.languages.join(',') : '';
            components.platform = navigator.platform;
            components.hardwareConcurrency = navigator.hardwareConcurrency || 0;
            components.maxTouchPoints = navigator.maxTouchPoints || 0;

            // Ëû¢ÂπïË≥áË®ä
            components.screenWidth = screen.width;
            components.screenHeight = screen.height;
            components.screenColorDepth = screen.colorDepth;
            components.screenPixelDepth = screen.pixelDepth;
            components.screenAvailWidth = screen.availWidth;
            components.screenAvailHeight = screen.availHeight;

            // ÊôÇÂçÄË≥áË®ä
            components.timezone = Intl.DateTimeFormat().resolvedOptions().timeZone;
            components.timezoneOffset = new Date().getTimezoneOffset();

            // Ë¶ñÁ™óË≥áË®ä
            components.windowInnerWidth = window.innerWidth;
            components.windowInnerHeight = window.innerHeight;
            components.windowOuterWidth = window.outerWidth;
            components.windowOuterHeight = window.outerHeight;

            // ÁÄèË¶ΩÂô®ÂäüËÉΩ
            components.cookieEnabled = navigator.cookieEnabled;
            components.doNotTrack = navigator.doNotTrack || 'unspecified';
            components.onlineStatus = navigator.onLine;

            // CanvasÊåáÁ¥ã
            components.canvasFingerprint = await this.generateCanvasFingerprint();

            // WebGLÊåáÁ¥ã
            components.webglFingerprint = this.generateWebGLFingerprint();

            // Â≠óÈ´îÊ™¢Ê∏¨
            components.fonts = await this.detectFonts();

            // Èü≥È†ª‰∏ä‰∏ãÊñá
            components.audioFingerprint = await this.generateAudioFingerprint();

            // Â≠òÂÑ≤ÊîØÊè¥
            components.localStorage = this.checkStorageSupport('localStorage');
            components.sessionStorage = this.checkStorageSupport('sessionStorage');
            components.indexedDB = this.checkStorageSupport('indexedDB');

            // Êèí‰ª∂Ë≥áË®äÔºàÈÉ®ÂàÜÁÄèË¶ΩÂô®ÊîØÊè¥Ôºâ
            components.plugins = this.getPluginsInfo();

            // Ë®≠ÂÇôË®òÊÜ∂È´îÔºàÂ¶ÇÊûúÂèØÁî®Ôºâ
            if ('deviceMemory' in navigator) {
                components.deviceMemory = navigator.deviceMemory;
            }

            // ÈÄ£Êé•Ë≥áË®äÔºàÂ¶ÇÊûúÂèØÁî®Ôºâ
            if ('connection' in navigator) {
                const conn = navigator.connection;
                components.connectionType = conn.effectiveType || 'unknown';
                components.connectionDownlink = conn.downlink || 0;
            }

            return components;

        } catch (error) {
            throw new DeviceError(`Êî∂ÈõÜË®≠ÂÇôË≥áË®äÂ§±Êïó: ${error.message}`);
        }
    }

    /**
     * ÁîüÊàêCanvasÊåáÁ¥ã
     */
    async generateCanvasFingerprint() {
        try {
            const canvas = document.createElement('canvas');
            const ctx = canvas.getContext('2d');
            
            canvas.width = 200;
            canvas.height = 50;
            
            // Áπ™Ë£ΩÊñáÂ≠ó
            ctx.textBaseline = 'top';
            ctx.font = '14px Arial';
            ctx.fillStyle = '#f60';
            ctx.fillRect(125, 1, 62, 20);
            ctx.fillStyle = '#069';
            ctx.fillText('Hello ‰Ω†Â•Ω üåü', 2, 15);
            
            // Áπ™Ë£ΩÂπæ‰ΩïÂúñÂΩ¢
            ctx.globalCompositeOperation = 'multiply';
            ctx.fillStyle = 'rgb(255,0,255)';
            ctx.beginPath();
            ctx.arc(50, 25, 20, 0, Math.PI * 2, true);
            ctx.closePath();
            ctx.fill();
            
            return canvas.toDataURL();
        } catch (error) {
            return 'canvas_not_supported';
        }
    }

    /**
     * ÁîüÊàêWebGLÊåáÁ¥ã
     */
    generateWebGLFingerprint() {
        try {
            const canvas = document.createElement('canvas');
            const gl = canvas.getContext('webgl') || canvas.getContext('experimental-webgl');
            
            if (!gl) {
                return 'webgl_not_supported';
            }

            const debugInfo = gl.getExtension('WEBGL_debug_renderer_info');
            const vendor = debugInfo ? gl.getParameter(debugInfo.UNMASKED_VENDOR_WEBGL) : 'unknown';
            const renderer = debugInfo ? gl.getParameter(debugInfo.UNMASKED_RENDERER_WEBGL) : 'unknown';
            
            return `${vendor}~${renderer}`;
        } catch (error) {
            return 'webgl_error';
        }
    }

    /**
     * Ê™¢Ê∏¨Â≠óÈ´î
     */
    async detectFonts() {
        const testFonts = [
            'Arial', 'Arial Black', 'Comic Sans MS', 'Courier New', 'Georgia',
            'Impact', 'Times New Roman', 'Trebuchet MS', 'Verdana', 'Webdings',
            'Microsoft YaHei', 'SimSun', 'SimHei', 'KaiTi', 'FangSong'
        ];

        const availableFonts = [];
        const testString = 'mmmmmmmmmmlli';
        const testSize = '72px';
        const baseFonts = ['monospace', 'sans-serif', 'serif'];

        // ÂâµÂª∫Ê∏¨Ë©¶ÂÆπÂô®
        const container = document.createElement('span');
        container.style.cssText = 'position:absolute;left:-9999px;font-size:' + testSize + ';';
        document.body.appendChild(container);

        try {
            for (const font of testFonts) {
                let detected = false;
                
                for (const baseFont of baseFonts) {
                    container.style.fontFamily = `"${font}",${baseFont}`;
                    container.textContent = testString;
                    
                    // Ê∏¨ÈáèÊñáÂ≠óÂØ¨Â∫¶
                    const width = container.offsetWidth;
                    
                    container.style.fontFamily = baseFont;
                    const baseWidth = container.offsetWidth;
                    
                    if (width !== baseWidth) {
                        detected = true;
                        break;
                    }
                }
                
                if (detected) {
                    availableFonts.push(font);
                }
            }
        } finally {
            document.body.removeChild(container);
        }

        return availableFonts.join(',');
    }

    /**
     * ÁîüÊàêÈü≥È†ªÊåáÁ¥ã
     */
    async generateAudioFingerprint() {
        try {
            const audioContext = new (window.AudioContext || window.webkitAudioContext)();
            const oscillator = audioContext.createOscillator();
            const analyser = audioContext.createAnalyser();
            const gainNode = audioContext.createGain();
            const scriptProcessor = audioContext.createScriptProcessor(4096, 1, 1);

            gainNode.gain.value = 0; // ÈùúÈü≥
            oscillator.type = 'triangle';
            oscillator.frequency.value = 10000;

            oscillator.connect(analyser);
            analyser.connect(scriptProcessor);
            scriptProcessor.connect(gainNode);
            gainNode.connect(audioContext.destination);

            oscillator.start(0);

            return new Promise((resolve) => {
                let attempt = 0;
                scriptProcessor.onaudioprocess = function(bins) {
                    if (attempt++ > 10) {
                        const floatFreqData = new Float32Array(analyser.frequencyBinCount);
                        analyser.getFloatFrequencyData(floatFreqData);
                        
                        oscillator.stop();
                        scriptProcessor.disconnect();
                        audioContext.close();
                        
                        resolve(floatFreqData.slice(0, 30).join(','));
                        return;
                    }
                };
            });
        } catch (error) {
            return 'audio_not_supported';
        }
    }

    /**
     * Ê™¢Êü•Â≠òÂÑ≤ÊîØÊè¥
     */
    checkStorageSupport(storageType) {
        try {
            const storage = window[storageType];
            const testKey = '__storage_test__';
            storage.setItem(testKey, 'test');
            storage.removeItem(testKey);
            return true;
        } catch (error) {
            return false;
        }
    }

    /**
     * Áç≤ÂèñÊèí‰ª∂Ë≥áË®ä
     */
    getPluginsInfo() {
        try {
            const plugins = [];
            for (let i = 0; i < navigator.plugins.length; i++) {
                const plugin = navigator.plugins[i];
                plugins.push({
                    name: plugin.name,
                    description: plugin.description,
                    filename: plugin.filename
                });
            }
            return plugins.map(p => `${p.name}~${p.description}`).join('|');
        } catch (error) {
            return 'plugins_not_accessible';
        }
    }

    /**
     * ÁµÑÂêàÊåáÁ¥ãÁµÑ‰ª∂
     */
    combineComponents(components) {
        const keys = Object.keys(components).sort();
        const values = keys.map(key => `${key}:${components[key]}`);
        return values.join('|');
    }

    /**
     * Â∞çÊåáÁ¥ãÈÄ≤Ë°åÈõúÊπä
     */
    async hashFingerprint(fingerprintString) {
        try {
            const encoder = new TextEncoder();
            const data = encoder.encode(fingerprintString);
            const hashBuffer = await crypto.subtle.digest('SHA-256', data);
            const hashArray = Array.from(new Uint8Array(hashBuffer));
            return hashArray.map(b => b.toString(16).padStart(2, '0')).join('');
        } catch (error) {
            // ÈôçÁ¥öÂà∞Á∞°ÂñÆÈõúÊπä
            return this.simpleHash(fingerprintString);
        }
    }

    /**
     * Á∞°ÂñÆÈõúÊπäÁÆóÊ≥ïÔºàÈôçÁ¥öÊñπÊ°àÔºâ
     */
    simpleHash(str) {
        let hash = 0;
        if (str.length === 0) return hash.toString();
        
        for (let i = 0; i < str.length; i++) {
            const char = str.charCodeAt(i);
            hash = ((hash << 5) - hash) + char;
            hash = hash & hash; // ËΩâÁÇ∫32‰ΩçÊï¥Êï∏
        }
        
        return Math.abs(hash).toString(16);
    }

    /**
     * Ê™¢Êü•Á∑©Â≠òÁöÑÊåáÁ¥ãÊòØÂê¶ÊúâÊïà
     */
    isValidCachedFingerprint() {
        if (!this.fingerprint || !this.fingerprintTimestamp) {
            return false;
        }
        
        const now = Date.now();
        return (now - this.fingerprintTimestamp) < this.cacheExpiration;
    }

    /**
     * ‰øùÂ≠òÊåáÁ¥ãÂà∞Á∑©Â≠ò
     */
    saveFingerprintToCache() {
        try {
            const cacheData = {
                fingerprint: this.fingerprint,
                timestamp: this.fingerprintTimestamp
            };
            localStorage.setItem('deviceFingerprint', JSON.stringify(cacheData));
        } catch (error) {
            // ÂøΩÁï•Á∑©Â≠òÈåØË™§
        }
    }

    /**
     * ÂæûÁ∑©Â≠òËºâÂÖ•ÊåáÁ¥ã
     */
    loadFingerprintFromCache() {
        try {
            const cacheData = JSON.parse(localStorage.getItem('deviceFingerprint') || '{}');
            if (cacheData.fingerprint && cacheData.timestamp) {
                this.fingerprint = cacheData.fingerprint;
                this.fingerprintTimestamp = cacheData.timestamp;
                return this.isValidCachedFingerprint();
            }
        } catch (error) {
            // ÂøΩÁï•Á∑©Â≠òÈåØË™§
        }
        return false;
    }

    /**
     * Áç≤ÂèñÁï∂ÂâçË®≠ÂÇôÊåáÁ¥ã
     */
    getCurrentFingerprint() {
        return this.fingerprint;
    }

    /**
     * Ê∏ÖÈô§Ë®≠ÂÇôÊåáÁ¥ãÁ∑©Â≠ò
     */
    clearFingerprintCache() {
        this.fingerprint = null;
        this.fingerprintTimestamp = null;
        localStorage.removeItem('deviceFingerprint');
    }

    /**
     * Ë®òÈåÑË®≠ÂÇô‰∫ã‰ª∂
     */
    logDeviceEvent(eventType, data = null, error = null) {
        const logEntry = {
            timestamp: new Date().toISOString(),
            eventType: eventType,
            data: data,
            error: error ? error.message : null
        };

        // ÈñãÁôºÊ®°Âºè‰∏ãËº∏Âá∫Âà∞ÊéßÂà∂Âè∞
        if (window.location.hostname === 'localhost' || window.location.hostname.includes('127.0.0.1')) {
            console.log('[Device Utils]', logEntry);
        }

        // Â≠òÂÑ≤Âà∞Êú¨Âú∞ÔºàÁî®ÊñºË™øË©¶Ôºâ
        try {
            const logs = JSON.parse(localStorage.getItem('deviceLogs') || '[]');
            logs.push(logEntry);
            
            // Âè™‰øùÁïôÊúÄËøë30Ê¢ùÊó•Ë™å
            if (logs.length > 30) {
                logs.splice(0, logs.length - 30);
            }
            
            localStorage.setItem('deviceLogs', JSON.stringify(logs));
        } catch (e) {
            // ÂøΩÁï•Â≠òÂÑ≤ÈåØË™§
        }
    }

    /**
     * Áç≤ÂèñË®≠ÂÇôÊó•Ë™å
     */
    getDeviceLogs() {
        try {
            return JSON.parse(localStorage.getItem('deviceLogs') || '[]');
        } catch (e) {
            return [];
        }
    }

    /**
     * Ê∏ÖÈô§Ë®≠ÂÇôÊó•Ë™å
     */
    clearDeviceLogs() {
        localStorage.removeItem('deviceLogs');
    }
}

/**
 * Ë®≠ÂÇôÈåØË™§È°ûÂûã
 */
class DeviceError extends Error {
    constructor(message, code = 'DEVICE_ERROR') {
        super(message);
        this.name = 'DeviceError';
        this.code = code;
        this.timestamp = new Date().toISOString();
    }
}

// ÂÖ®ÂüüÂ∞éÂá∫
if (typeof window !== 'undefined') {
    window.DeviceUtils = DeviceUtils;
    window.DeviceError = DeviceError;
}